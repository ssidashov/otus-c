# Устранение утечек памяти в тестовой библиотеке clib.

Необходимо, с помощью инструментов разработки языка C и UNIX, найти утечки памяти в библиотеке clib.

## Найденные утечки

- В clib-package.c:1386: передача в библиотеку, реализующую хеш таблицу строки, память для который выделена в куче функцией strdup. В случае, если уже есть запись в хеш таблице указатель теряется из области видимости, но не записывается в хеш таблицу. Таким образом эта строка не доступна для освобождения через хеш таблицу. Исправление - перед тем, как передавать копию строки в функцию hash_set проверяем, что хеш таблица не содержит данного ключа, и указатель на строку гарантирванно будет доступен для освобождения через итерацию хещ-таблицы. Более правильным было бы изменить код библиотеки хеш-таблицы, чтобы она делала копии ключей и значений и владела выделенными участками памяти, но это потребовало бы изменения кода библиотеки.
- В clib-package.c:662: неосвобождение указателя на ответ http http_get_response_t* в случае, когда запрос был не успешен и происходит retry. Предыдущий результат запроса перезаписывается следующим результатом без освобождения. Исправление - перед запросом делаеть освобождение предыдущего результата, если он есть.
- В clib-package.c:1496,1526 (2 места утечки): неверное получение указателя на выделенную в отдельном thread память (значение int) для передачи статуса, что ведет к неправльному освобождению этой памяти. Вместо того, чтобы передавать в pthread_join указатель на указатель, чтобы функция записала указатель, который можно освободить, передеается указатель (NULL), что предотвращает передачу результата как указателя и приводит к потере возможности освобождения памяти.
